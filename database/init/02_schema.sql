-- Schemat aplikacyjny: definicja tabel, sekwencji i kluczy obcych.

ALTER SESSION SET CURRENT_SCHEMA = APP;

-- Tabela: APP_CUSTOMER
-- Klienci systemu

CREATE TABLE APP_CUSTOMER (
    CUSTOMER_ID NUMBER PRIMARY KEY,
    EMAIL VARCHAR2(255) NOT NULL UNIQUE,
    FULL_NAME VARCHAR2(255) NOT NULL,
    CREATED_AT TIMESTAMP DEFAULT SYSTIMESTAMP
);

CREATE SEQUENCE SEQ_CUSTOMER START WITH 1 INCREMENT BY 1;


-- Tabela: APP_PRODUCT
-- Produkty oferowane w systemie

CREATE TABLE APP_PRODUCT (
    PRODUCT_ID NUMBER PRIMARY KEY,
    SKU VARCHAR2(64) NOT NULL UNIQUE,
    NAME VARCHAR2(255) NOT NULL,
    PRICE NUMBER(12,2) NOT NULL CHECK (PRICE >= 0),
    CREATED_AT TIMESTAMP DEFAULT SYSTIMESTAMP
);

CREATE SEQUENCE SEQ_PRODUCT START WITH 1 INCREMENT BY 1;


-- Tabela: APP_ORDER
-- Zamówienia klientów

CREATE TABLE APP_ORDER (
    ORDER_ID NUMBER PRIMARY KEY,
    CUSTOMER_ID NUMBER NOT NULL REFERENCES APP_CUSTOMER(CUSTOMER_ID),
    ORDER_TS TIMESTAMP DEFAULT SYSTIMESTAMP,
    STATUS VARCHAR2(32) CHECK (STATUS IN ('NEW', 'PAID', 'CANCELLED', 'SHIPPED')),
    NOTE VARCHAR2(4000)
);

CREATE SEQUENCE SEQ_ORDER START WITH 1 INCREMENT BY 1;


-- Tabela: APP_ORDER_ITEM
-- Pozycje zamówień

CREATE TABLE APP_ORDER_ITEM (
    ORDER_ITEM_ID NUMBER PRIMARY KEY,
    ORDER_ID NUMBER NOT NULL REFERENCES APP_ORDER(ORDER_ID) ON DELETE CASCADE,
    PRODUCT_ID NUMBER NOT NULL REFERENCES APP_PRODUCT(PRODUCT_ID),
    QTY NUMBER(10) NOT NULL CHECK (QTY > 0),
    UNIT_PRICE NUMBER(12,2) NOT NULL CHECK (UNIT_PRICE >= 0)
);

CREATE SEQUENCE SEQ_ORDER_ITEM START WITH 1 INCREMENT BY 1;

-- Tabela: APP_AUDIT_LOG
-- Log operacji INSERT/UPDATE/DELETE

CREATE TABLE APP_AUDIT_LOG (
    ID NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
    OBJ_NAME VARCHAR2(64) NOT NULL,
    OBJ_ID NUMBER,
    OPERATION VARCHAR2(16) NOT NULL,
    CHANGED_AT TIMESTAMP DEFAULT SYSTIMESTAMP,
    DETAILS VARCHAR2(4000)
);


-- Tabela: APP_REJECTED_ROWS
-- Dane odrzucone podczas walidacji

CREATE TABLE APP_REJECTED_ROWS (
    ID NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
    SRC VARCHAR2(64) NOT NULL,
    ROW_PAYLOAD CLOB,
    REASON VARCHAR2(4000),
    CREATED_AT TIMESTAMP DEFAULT SYSTIMESTAMP
);


-- Tabela: APP_METRICS
-- Metryki biznesowe dla analizatora
CREATE TABLE APP_METRICS (
    TS TIMESTAMP PRIMARY KEY,
    ORDERS_CNT NUMBER,
    REVENUE_SUM NUMBER(14,2),
    TOP_SKU VARCHAR2(64),
    BAD_ROWS NUMBER
);
